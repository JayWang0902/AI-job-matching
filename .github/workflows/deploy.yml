name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  # Convert repository name to lowercase for ghcr.io
  IMAGE_PREFIX: jaywang0902/ai-job-matching

jobs:
  # Job 1: Build and Push Docker Images
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      image-tag: ${{ steps.meta.outputs.version }}
      backend-changed: ${{ steps.changes.outputs.backend }}
      celery-changed: ${{ steps.changes.outputs.celery }}
      frontend-changed: ${{ steps.changes.outputs.frontend }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check for file changes
        id: changes
        run: |
          # Check if backend files changed
          if git diff --name-only HEAD~1 HEAD | grep -qE '^(app/|requirements.txt|Dockerfile|alembic/)'; then
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "Backend files changed"
          else
            echo "backend=false" >> $GITHUB_OUTPUT
            echo "No backend changes"
          fi
          
          # Check if celery files changed (same as backend for this project)
          if git diff --name-only HEAD~1 HEAD | grep -qE '^(app/|requirements.txt|Dockerfile.celery|alembic/)'; then
            echo "celery=true" >> $GITHUB_OUTPUT
            echo "Celery files changed"
          else
            echo "celery=false" >> $GITHUB_OUTPUT
            echo "No celery changes"
          fi
          
          # Check if frontend files changed
          if git diff --name-only HEAD~1 HEAD | grep -qE '^frontend/'; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "Frontend files changed"
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
            echo "No frontend changes"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          VERSION="${GITHUB_SHA::8}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Image tag: ${VERSION}"

      - name: Build and push backend image
        if: steps.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:latest
          cache-from: |
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:latest
            type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push celery image
        if: steps.changes.outputs.celery == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.celery
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-celery:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-celery:latest
          cache-from: |
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-celery:latest
            type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push frontend image
        if: steps.changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:latest
          cache-from: |
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:latest
            type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}

  # Job 2: Deploy to EC2
  deploy:
    name: Deploy to EC2
    needs: build-and-push
    runs-on: ubuntu-latest
    # Deploy on push to main, or when manually triggered
    # Skip deploy if no code changes (only docs/workflow changes)
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known_hosts
        run: |
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
          PROJECT_DIR: ${{ secrets.EC2_PROJECT_DIR }}
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
          BACKEND_CHANGED: ${{ needs.build-and-push.outputs.backend-changed }}
          CELERY_CHANGED: ${{ needs.build-and-push.outputs.celery-changed }}
          FRONTEND_CHANGED: ${{ needs.build-and-push.outputs.frontend-changed }}
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_PREFIX: ${{ env.IMAGE_PREFIX }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Set default project directory if not provided
          PROJECT_DIR="${PROJECT_DIR:-/home/ubuntu/AI-job-matching}"
          
          # Determine which image tag to use for each service
          # Use commit SHA for built services, 'latest' for unchanged services
          if [[ "${BACKEND_CHANGED}" == "true" ]]; then
            BACKEND_TAG="${IMAGE_TAG}"
            echo "‚úì Backend built with tag: ${BACKEND_TAG}"
          else
            BACKEND_TAG="latest"
            echo "‚ö†Ô∏è Backend not built, using latest"
          fi
          
          if [[ "${CELERY_CHANGED}" == "true" ]]; then
            CELERY_TAG="${IMAGE_TAG}"
            echo "‚úì Celery built with tag: ${CELERY_TAG}"
          else
            CELERY_TAG="latest"
            echo "‚ö†Ô∏è Celery not built, using latest"
          fi
          
          if [[ "${FRONTEND_CHANGED}" == "true" ]]; then
            FRONTEND_TAG="${IMAGE_TAG}"
            echo "‚úì Frontend built with tag: ${FRONTEND_TAG}"
          else
            FRONTEND_TAG="latest"
            echo "‚ö†Ô∏è Frontend not built, using latest"
          fi
          
          # Deploy via SSH - pass all variables as environment
          ssh "${USER}@${HOST}" \
            PROJECT_DIR="${PROJECT_DIR}" \
            BACKEND_TAG="${BACKEND_TAG}" \
            CELERY_TAG="${CELERY_TAG}" \
            FRONTEND_TAG="${FRONTEND_TAG}" \
            REGISTRY="${REGISTRY}" \
            IMAGE_PREFIX="${IMAGE_PREFIX}" \
            GITHUB_TOKEN="${GITHUB_TOKEN}" \
            GITHUB_REPO="${{ github.repository }}" \
            GITHUB_ACTOR="${{ github.actor }}" \
            bash << 'ENDSSH'
          set -e
          
          echo "==> Navigating to project directory: ${PROJECT_DIR}"
          mkdir -p "${PROJECT_DIR}"
          cd "${PROJECT_DIR}"
          
          # Initialize git repo if not exists
          if [ ! -d .git ]; then
            echo "==> Initializing git repository"
            git init
            git remote add origin "https://github.com/${GITHUB_REPO}.git"
          fi
          
          echo "==> Pulling latest code"
          git fetch --all --prune
          git reset --hard origin/main
          
          echo "==> Logging into GitHub Container Registry"
          echo "${GITHUB_TOKEN}" | docker login ghcr.io -u "${GITHUB_ACTOR}" --password-stdin
          
          echo "==> Pulling images with appropriate tags"
          echo "  Backend: ${BACKEND_TAG}"
          echo "  Celery: ${CELERY_TAG}"
          echo "  Frontend: ${FRONTEND_TAG}"
          
          # Create docker-compose override with specific tags using printf
          printf 'version: "3.9"\nservices:\n  backend:\n    image: %s/%s-backend:%s\n  celery:\n    image: %s/%s-celery:%s\n  frontend:\n    image: %s/%s-frontend:%s\n' \
            "${REGISTRY}" "${IMAGE_PREFIX}" "${BACKEND_TAG}" \
            "${REGISTRY}" "${IMAGE_PREFIX}" "${CELERY_TAG}" \
            "${REGISTRY}" "${IMAGE_PREFIX}" "${FRONTEND_TAG}" \
            > docker-compose.override.yml
          
          echo "==> Generated docker-compose.override.yml:"
          cat docker-compose.override.yml
          
          echo "==> Pulling latest images"
          docker compose pull
          
          echo "==> Stopping old containers"
          docker compose down
          
          echo "==> Starting services with new images"
          docker compose up -d
          
          echo "==> Waiting for services to be ready (health check)"
          sleep 10
          
          echo "==> Health check (retry up to 12 times, 5s interval)"
          ok=0
          for i in {1..12}; do
            if docker compose ps | grep -q "backend.*Up.*healthy"; then
              echo "‚úì Backend is healthy"
              ok=1
              break
            else
              echo "‚è≥ Health check not ready, retry $i..."
              sleep 5
            fi
          done
          
          if [ "$ok" -ne 1 ]; then
            echo "‚ùå Health check failed, showing logs:"
            docker compose ps
            docker compose logs --tail=100
            exit 1
          fi
          
          echo "==> Deployment successful!"
          
          echo "==> Cleaning up old images"
          docker image prune -f --filter "until=72h"
          docker builder prune -af --filter "until=72h"
          ENDSSH

      - name: Verify deployment
        env:
          HEALTH_URL: ${{ secrets.HEALTH_URL }}
        run: |
          echo "==> Final health check from GitHub Actions"
          
          # Skip if HEALTH_URL not configured
          if [ -z "${HEALTH_URL}" ]; then
            echo "‚ö†Ô∏è  HEALTH_URL not configured, skipping external health check"
            echo "üí° To enable: Add HEALTH_URL secret with value: http://YOUR_EC2_IP:8000/health"
            exit 0
          fi
          
          for i in {1..5}; do
            if curl -fsS "${HEALTH_URL}" > /dev/null 2>&1; then
              echo "‚úì Deployment verified - service is healthy from external network"
              exit 0
            else
              echo "‚è≥ Waiting for service to be reachable, attempt $i..."
              sleep 5
            fi
          done
          
          echo "‚ö†Ô∏è  Service not reachable from external network, but deployment completed on EC2"
          echo "üí° This is often normal - check security groups allow 0.0.0.0/0 on port 8000"


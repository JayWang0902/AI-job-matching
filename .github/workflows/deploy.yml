name: Deploy to EC2 on push to main

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known_hosts
        run: |
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: SSH and deploy
        env:
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
          PROJECT_DIR: ${{ secrets.EC2_PROJECT_DIR }}
          HEALTH_URL: ${{ secrets.HEALTH_URL }}
        run: |
          ssh "${USER}@${HOST}" <<EOF
          set -e

          echo "==> cd 到项目目录"
          cd "${PROJECT_DIR}"

          echo "==> 拉最新代码（以 main 为例）"
          git fetch --all --prune
          git reset --hard origin/main

          echo "==> 停旧容器（忽略报错）"
          docker compose down || true

          echo "==> 构建并启动（-d 后台；--build 每次重新构建镜像）"
          docker compose up -d --build

          echo "==> 健康检查（最多重试 10 次，每次间隔 3s）"
          ok=0
          for i in {1..10}; do
            if curl -fsS "${HEALTH_URL}" > /dev/null; then
              echo "health ok"
              ok=1
              break
            else
              echo "health not ready, retry \$i..."
              sleep 3
            fi
          done

          if [ "\$ok" -ne 1 ]; then
            echo "健康检查失败，打印最近日志方便排错："
            docker compose ps || true
            docker compose logs --tail=100 || true
            exit 1
          fi
          EOF


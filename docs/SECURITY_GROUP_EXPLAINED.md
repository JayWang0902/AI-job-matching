# 🔒 AWS 安全组（Security Group）详解

## 什么是安全组？

AWS 安全组就像是 EC2 实例的**防火墙**，控制哪些流量可以进出你的服务器。

---

## 入站规则 vs 出站规则

### 📥 入站规则（Inbound Rules）
**方向**: 外部 → EC2 服务器

**含义**: 允许哪些外部流量访问你的 EC2

**示例场景**:
```
用户浏览器 (外部)  →  访问端口 3000  →  EC2 上的 Frontend
   ❌ 如果没有入站规则，会被防火墙拦截
   ✅ 添加入站规则后，流量可以到达
```

### 📤 出站规则（Outbound Rules）
**方向**: EC2 服务器 → 外部

**含义**: 允许你的 EC2 访问哪些外部服务

**示例场景**:
```
EC2 上的 Backend  →  访问 OpenAI API (外部)
EC2 上的 Backend  →  访问 AWS S3 (外部)
EC2 上的 Backend  →  访问 AWS RDS (外部)
```

**注意**: 出站规则默认允许所有流量，通常不需要修改。

---

## 为什么需要配置端口 8000、3000、6379？

### 🌐 实际访问流程

#### 场景 1: 用户访问前端
```
1. 用户在浏览器输入: http://54.123.45.67:3000
   
2. 请求到达 EC2 的防火墙（安全组）
   │
   ├─ 检查: 是否允许端口 3000 的入站流量？
   │   ❌ 没有规则 → 拒绝访问（连接超时）
   │   ✅ 有规则 → 允许通过
   │
3. 请求到达 EC2 上的 Docker 容器
   │
4. Frontend 容器监听 3000 端口，处理请求
   │
5. 返回网页给用户
```

#### 场景 2: 前端调用后端 API
```
1. 前端 JavaScript 发起请求: fetch('http://54.123.45.67:8000/api/...')
   
2. 请求到达 EC2 的防火墙
   │
   ├─ 检查: 是否允许端口 8000 的入站流量？
   │   ❌ 没有规则 → API 调用失败
   │   ✅ 有规则 → 允许通过
   │
3. Backend 容器处理 API 请求
   │
4. 返回 JSON 数据
```

#### 场景 3: Redis 端口 6379
```
情况 A: Redis 仅供内部使用（推荐）
┌─────────────────────────────────────┐
│          EC2 实例内部                │
│                                     │
│  Backend Container  ←──┐           │
│                        │           │
│  Celery Container   ←──┼─→ Redis  │
│                        │   (6379)  │
│  Frontend Container ←──┘           │
│                                     │
└─────────────────────────────────────┘
   ↑ 不需要入站规则，因为都在内部通信

情况 B: 需要外部访问 Redis（不推荐）
外部 Redis 客户端 → 端口 6379 → EC2 Redis
   ↑ 需要入站规则，但这会带来安全风险！
```

---

## 推荐的安全组配置

### ✅ 最小权限原则配置

```yaml
入站规则:
  - 规则 1: SSH 访问（管理用）
    类型: SSH
    协议: TCP
    端口: 22
    源: 你的 IP 地址（如 123.45.67.89/32）
    说明: 仅允许你的电脑 SSH 到 EC2
    
  - 规则 2: Backend API
    类型: Custom TCP
    协议: TCP
    端口: 8000
    源: 0.0.0.0/0 (所有 IP)
    说明: 允许任何人访问 API（公开服务）
    
  - 规则 3: Frontend
    类型: Custom TCP
    协议: TCP
    端口: 3000
    源: 0.0.0.0/0 (所有 IP)
    说明: 允许任何人访问网站（公开服务）
    
  - 规则 4: Redis (可选 - 不推荐)
    类型: Custom TCP
    协议: TCP
    端口: 6379
    源: ❌ 不要添加！
    说明: Redis 应该只在 Docker 内部网络访问

出站规则:
  - 默认: 允许所有出站流量
    说明: 允许 EC2 访问互联网（下载包、调用外部 API 等）
```

---

## 端口映射详解

### Docker Compose 中的端口映射

```yaml
services:
  backend:
    ports:
      - "8000:8000"
    #    ↑     ↑
    #    │     └─ 容器内部端口（Backend FastAPI 监听）
    #    └─────── 主机端口（EC2 对外暴露）
```

### 完整的访问链路

```
用户浏览器
    │
    │ (1) 发起请求到 http://54.123.45.67:8000
    ↓
AWS 安全组（防火墙）
    │
    │ (2) 检查入站规则: 端口 8000 是否允许？
    ↓
EC2 主机（端口 8000）
    │
    │ (3) Docker 端口映射: 8000 → backend 容器的 8000
    ↓
Backend 容器（端口 8000）
    │
    │ (4) FastAPI 应用处理请求
    ↓
返回响应
```

---

## 常见问题

### Q1: 为什么要开放 0.0.0.0/0（所有 IP）？

**A**: 对于公开的 Web 服务（Frontend、API），你希望任何人都能访问。

**安全替代方案**:
- 如果是内部系统，可以限制为公司 IP 段
- 使用 CloudFront CDN + WAF 做额外防护
- 在应用层实现认证（JWT）而不是网络层限制

### Q2: Redis 到底要不要开放端口？

**A**: **99% 情况下不需要！**

```
❌ 不推荐: 开放 6379 到公网
  - 安全风险极高
  - 容易被扫描和攻击
  - Redis 默认没有强认证

✅ 推荐: 仅 Docker 内部访问
  - Backend 和 Celery 通过 Docker 网络访问 Redis
  - 使用 redis://redis:6379 (DNS 名称，不是公网 IP)
  - 不需要任何入站规则
```

**需要开放的特殊情况**:
- 远程调试 Redis
- 使用外部 Redis 监控工具

**此时也要限制源 IP**:
```yaml
源: 你的办公室 IP/32  # 不要用 0.0.0.0/0
```

### Q3: 如何测试端口是否开放？

```bash
# 从本地测试 EC2 端口
nc -zv 54.123.45.67 8000
# 成功: Connection to 54.123.45.67 port 8000 [tcp/*] succeeded!
# 失败: Connection refused 或 timeout

# 或使用 telnet
telnet 54.123.45.67 8000

# 或使用 curl
curl -v http://54.123.45.67:8000/health
```

### Q4: 修改安全组需要重启 EC2 吗？

**A**: **不需要！** 安全组规则立即生效。

---

## 安全最佳实践

### 1. SSH 端口限制
```yaml
❌ 差的配置:
端口 22 开放给 0.0.0.0/0
→ 全世界都可以尝试暴力破解你的 SSH

✅ 好的配置:
端口 22 仅开放给你的 IP
→ 只有你可以 SSH 登录
```

### 2. 使用 HTTPS（生产环境）
```yaml
当前开发配置:
  - HTTP 端口 8000, 3000

生产环境配置:
  - 使用 Nginx 反向代理
  - 配置 SSL 证书（Let's Encrypt）
  - 仅开放 443 (HTTPS) 和 80 (HTTP 重定向)
  - 关闭 8000, 3000 的直接访问
```

### 3. 使用负载均衡器（高级）
```
用户
  ↓
AWS Application Load Balancer (ALB)
  │ - 处理 HTTPS
  │ - 自动证书管理
  │ - DDoS 防护
  ↓
EC2 (安全组仅允许 ALB 访问)
  - Backend 和 Frontend 不直接暴露在公网
```

---

## 快速参考

| 端口 | 服务 | 需要入站规则？ | 源 | 原因 |
|------|------|--------------|-----|------|
| 22 | SSH | ✅ 是 | 你的 IP | 远程管理 EC2 |
| 8000 | Backend API | ✅ 是 | 0.0.0.0/0 | 公开 API 访问 |
| 3000 | Frontend | ✅ 是 | 0.0.0.0/0 | 公开网站访问 |
| 6379 | Redis | ❌ 否 | - | 仅 Docker 内部 |
| 5432 | PostgreSQL | ❌ 否* | - | 使用 RDS，不在 EC2 上 |

*注: 如果 PostgreSQL 在 EC2 上而不是 RDS，也不应该开放到公网，应该限制为应用服务器的 IP。

---

## 总结

**入站规则的本质**:
- 控制**谁可以连接到你的服务器**
- 8000、3000 需要开放，因为用户需要访问
- 6379 不需要开放，因为只有容器内部访问
- 安全组是第一道防线，但不是唯一防线
- 应用层认证（JWT）+ 网络层限制 = 纵深防御
